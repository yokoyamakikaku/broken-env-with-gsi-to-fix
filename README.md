# GSIã«é–¢ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã®å†ç¾

Amplifyã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«GSIã«é–¢ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦ã¿ã¦ã‚‚æˆåŠŸã—ãªã„çŠ¶æ…‹ã«ãªã£ãŸã€‚å†åº¦æ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã¯ãªãã€ç’°å¢ƒã‚’ä½œã‚Šç›´ã™å¿…è¦ãŒå‡ºãŸã€‚

é–¢é€£ã™ã‚‹ã‚¤ã‚·ãƒ¥ãƒ¼ã‚‚ã„ãã¤ã‹ã‚ã£ãŸãŒè§£æ±ºç­–ãŒæ˜ç¤ºã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚ãã®ãŸã‚ã€ç’°å¢ƒã‚’å†ç¾ã™ã‚‹æ‰‹é †ã‚’ã¾ã¨ã‚åŸå› ã®èª¿æŸ»ã«åˆ©ç”¨ã™ã‚‹ã€‚

## ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã¦ã‹ã‚‰å†ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããªããªã£ãŸã€‚

```
"Cannot update GSI's properties other than Provisioned Throughput and Contributor Insights Specification. You can create a new GSI with a different name."
```

## é–¢é€£ã™ã‚‹ã‚¤ã‚·ãƒ¥ãƒ¼


- [Error: Cannot update GSI's properties other than Provisioned Throughput and Contributor Insights Specification. You can create a new GSI with a different name.](https://github.com/aws-amplify/amplify-category-api/issues/774)
- [Amplify push got error "Message: Resource is not in the state stackUpdateComplete"](https://github.com/aws-amplify/amplify-category-api/issues/92)


# ç’°å¢ƒã®å†ç¾

ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿã«ã¯è¤‡æ•°æ¡ä»¶ãŒã‚ã‚‹ãŒä¸»è¦ãªéƒ¨åˆ†ã¯ä»¥ä¸‹ã®é€šã‚Šã‚ã‚‹ã€‚

- ååˆ†ã«å¤šã„ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã®ï¼’å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ•°ãŒã‚ã‚‹ä¸€å®šæ•°ã‚’è¶…ãˆã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ™‚é–“ãŒ30åˆ†ä»¥ä¸Šã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚30åˆ†ã¯Amplifyã®åˆæœŸè¨­å®šã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®æ™‚é–“ã§ã‚ã‚‹ã€‚
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸçŠ¶æ…‹ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡ŒãŠã†ã¨ã™ã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã§ã‚ã‚‹ã¨åˆ¤æ–­ã•ã‚Œãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã™ã‚‹ã€‚
ãã®å¾Œã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡ŒãŠã†ã¨ã™ã‚‹ã¨GSIã«é–¢ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚

## é–‹ç™ºç’°å¢ƒ

```
% node -v
v18.16.0
% npm -v
9.5.1
```

## ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
% npm i
```

## Amplify ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

æ—¢å­˜ã® Amplify ã«é–¢ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã€æ–°ãŸãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
èªè¨¼ã¨APIã‚’è¿½åŠ ã™ã‚‹ã€‚èªè¨¼ã¯ GraphQL ã‚’ä½¿ã†ã€‚

```
% rm -rf amplify
% amplify init
% amplify add auth
% amplify push -y
% amplify add api
% amplify push -y
```

## ãƒªãƒã‚¸ãƒˆãƒªã®æ¥ç¶š

GitHub ãªã©ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦é€£æºã™ã‚‹ã€‚
ãƒªãƒã‚¸ãƒˆãƒªã‚’æ¥ç¶šã—ã¦è¨­å®šã—ã€å¯¾è±¡ã®ãƒ–ãƒ©ãƒ³ãƒã«å¤‰æ›´ãŒã‚ã£ãŸæ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
ãƒ–ãƒ©ãƒ³ãƒã®æ¥ç¶šã«é–¢ã—ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã•ã‚ŒãŸã„ã€‚

## ã‚¹ã‚­ãƒ¼ãƒã®è¨­å®š

`/schemas/schema.0.graphql` ã‚’ `/amplify/backend/api/[appName]/schema.graphql` ã«ã‚³ãƒ”ãƒ¼ã—ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚

##ã€€ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªå¯¾è©±ã«è¿”ç­”ã—ãªãŒã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹

```
% node scripts/create-data/index.mjs
? AWS Profile ã‚’é¸æŠã—ã¦ãã ã•ã„ ******
? ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ ap-northeast-1
? UserPool ã‚’é¸æŠã—ã¦ãã ã•ã„ ******
? User ã‚’é¸æŠã—ã¦ãã ã•ã„ ******(******) (******)
? APIã‚’é¸æŠã—ã¦ãã ã•ã„ ******
? ä½œæˆã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 20
? ä½œæˆã™ã‚‹ãƒ¦ãƒ¼ã‚¶ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 200
? ä½œæˆã™ã‚‹æœ¬ã®ã‚«ãƒ†ã‚´ãƒªã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 400
? ä½œæˆã™ã‚‹æœ¬ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 2000
? ä½œæˆã™ã‚‹æœ¬ã®ã‚³ãƒ¡ãƒ³ãƒˆã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 10000
? ä½œæˆã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 1000
? ä½œæˆã™ã‚‹äºˆå®šã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 1000
? ä½œæˆã™ã‚‹è¨˜äº‹åˆ†é¡ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 20
? ä½œæˆã™ã‚‹è¨˜äº‹ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 1000
? ä½œæˆã™ã‚‹ä½œæ¥­ã®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ 1000
```

##ã€€ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´

`/schemas/schema.2.graphql` ã‚’ `/amplify/backend/api/[appName]/schema.graphql` ã«ã‚³ãƒ”ãƒ¼ã—ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚

ã“ã®æ™‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã™ã‚‹ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚

```
                                 # Starting phase: build
2023-06-27T11:20:43.907Z [INFO]: [0mAmplify AppID found: d2y19gw9w63o6p. Amplify App name is: brokenenvwithgsi[0m
2023-06-27T11:20:43.964Z [INFO]: [0mBackend environment main found in Amplify Console app: brokenenvwithgsi[0m
2023-06-27T11:20:44.818Z [WARNING]: - Fetching updates to backend environment: main from the cloud.
2023-06-27T11:20:45.583Z [WARNING]: - Building resource api/brokenenvwithgsi
2023-06-27T11:20:47.616Z [INFO]: âš ï¸ WARNING: owners may reassign ownership for the following model(s) and role(s): Group: [owner], User: [owner], BookCategory: [owner], Book: [owner], Comment: [owner], Message: [owner], Schedule: [owner], PostCategory: [owner], Post: [owner], Todo: [owner]. If this is not intentional, you may want to apply field-level authorization rules to these fields. To read more: https://docs.amplify.aws/cli/graphql/authorization-rules/#per-user--owner-based-data-access.
2023-06-27T11:20:47.883Z [INFO]: âœ… GraphQL schema compiled successfully.
                                 Edit your schema at /codebuild/output/src369714442/src/broken-env-with-gsi/amplify/backend/api/brokenenvwithgsi/schema.graphql or place .graphql files in a directory at /codebuild/output/src369714442/src/broken-env-with-gsi/amplify/backend/api/brokenenvwithgsi/schema
2023-06-27T11:20:47.884Z [WARNING]: - Building resource auth/brokenenvwithgsibc0e92fd
2023-06-27T11:20:47.927Z [WARNING]: âœ” Successfully pulled backend environment main from the cloud.
2023-06-27T11:20:47.965Z [INFO]: âœ…
2023-06-27T11:20:51.148Z [INFO]: [33mNote: It is recommended to run this command from the root of your app directory[39m
2023-06-27T11:20:51.303Z [WARNING]: - Initializing your environment: main
2023-06-27T11:20:52.170Z [WARNING]: - Building resource api/brokenenvwithgsi
2023-06-27T11:20:53.968Z [INFO]: âš ï¸ WARNING: owners may reassign ownership for the following model(s) and role(s): Group: [owner], User: [owner], BookCategory: [owner], Book: [owner], Comment: [owner], Message: [owner], Schedule: [owner], PostCategory: [owner], Post: [owner], Todo: [owner]. If this is not intentional, you may want to apply field-level authorization rules to these fields. To read more: https://docs.amplify.aws/cli/graphql/authorization-rules/#per-user--owner-based-data-access.
2023-06-27T11:20:54.270Z [INFO]: âœ… GraphQL schema compiled successfully.
                                 Edit your schema at /codebuild/output/src369714442/src/broken-env-with-gsi/amplify/backend/api/brokenenvwithgsi/schema.graphql or place .graphql files in a directory at /codebuild/output/src369714442/src/broken-env-with-gsi/amplify/backend/api/brokenenvwithgsi/schema
2023-06-27T11:20:54.271Z [WARNING]: - Building resource auth/brokenenvwithgsibc0e92fd
2023-06-27T11:20:54.313Z [WARNING]: âœ” Initialized provider successfully.
2023-06-27T11:20:54.681Z [WARNING]: âœ– There was an error initializing your environment.
2023-06-27T11:20:54.682Z [INFO]: ğŸ›‘ Cannot iteratively rollback as the following step does not contain a previousMetaKey: {"status":"DEPLOYING"}
                                 Learn more at: https://docs.amplify.aws/cli/project/troubleshooting/
2023-06-27T11:20:54.699Z [INFO]:
2023-06-27T11:20:54.699Z [INFO]: Session Identifier: e5781fc3-6e96-4387-bc8f-188dcaed85ce
2023-06-27T11:20:54.699Z [WARNING]: - Creating Zip
2023-06-27T11:20:54.715Z [INFO]: âœ… Report saved: /tmp/brokenenvwithgsi/report-1687864854702.zip
2023-06-27T11:20:54.716Z [INFO]:
2023-06-27T11:20:54.716Z [WARNING]: - Sending zip
2023-06-27T11:20:56.310Z [WARNING]: âœ” Done
2023-06-27T11:20:56.310Z [INFO]: Project Identifier: 5dba35224393ff9d7764fe2755d3c8e8
2023-06-27T11:20:56.332Z [ERROR]: !!! Build failed
2023-06-27T11:20:56.332Z [INFO]: Please check the supported SSR features to find if your build failure is related to an unsupported feature: https://docs.aws.amazon.com/amplify/latest/userguide/ssr-Amplify-support.html#supported-unsupported-features. You may also find this troubleshooting guide useful: https://docs.aws.amazon.com/amplify/latest/userguide/troubleshooting-ssr-deployment.html
2023-06-27T11:20:56.332Z [ERROR]: !!! Non-Zero Exit Code detected
2023-06-27T11:20:56.333Z [INFO]: # Starting environment caching...
2023-06-27T11:20:56.333Z [INFO]: # Uploading environment cache artifact...
2023-06-27T11:20:56.456Z [INFO]: # Uploaded environment cache artifact
2023-06-27T11:20:56.456Z [INFO]: # Environment caching completed
Terminating logging...
```

##ã€€ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤

åŒã˜çŠ¶æ…‹ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚ã“ã“ã§ã‚‚å¤±æ•—ã™ã‚‹

```
% amplify push -y
```

##ã€€å†åº¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã™ã‚‹

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‹ã‚‰ã€Œã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’è¡Œã†ã€‚

ãã“ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚

```
2023-06-27T11:38:04.383Z [INFO]: ğŸ›‘ The following resources failed to deploy:
                                 Resource Name: BookTable (AWS::DynamoDB::Table)
                                 Event Type: update
                                 Reason: Resource handler returned message: "Cannot perform more than one GSI creation or deletion in a single update" (RequestToken: 2f71b790-fda0-83a5-752a-35db9c619660, HandlerErrorCode: InvalidRequest)
                                 URL: https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/arn%3Aaws%3Acloudformation%3Aap-northeast-1%3A693825121436%3Astack%2Famplify-brokenenvwithgsi-main-202440-apibrokenenvwithgsi-ZWFILMZMSSBQ-Book-1HT67HFNB7H3T%2F2f723040-1417-11ee-bf01-06a04fef5983/events
                                 Resource Name: ScheduleTable (AWS::DynamoDB::Table)
                                 Event Type: update
                                 Reason: Resource handler returned message: "Cannot perform more than one GSI creation or deletion in a single update" (RequestToken: fcd1554f-cef0-7293-bc21-cf498fe3e255, HandlerErrorCode: InvalidRequest)
                                 URL: https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/arn%3Aaws%3Acloudformation%3Aap-northeast-1%3A693825121436%3Astack%2Famplify-brokenenvwithgsi-main-202440-apibrokenenvwithgsi-ZWFILMZMSSBQ-Schedule-1LFHW0EEQP1PP%2F56df9da0-1487-11ee-b1e1-067eb25769dd/events
2023-06-27T11:38:04.384Z [INFO]: Resource Name: UserTable (AWS::DynamoDB::Table)
```

ã“ã‚Œã‚¨ãƒ©ãƒ¼ã‚’å†ç¾ã§ãã‚‹ã€‚

# æ³¨æ„

ã‚¨ãƒ©ãƒ¼ã®å†ç¾ã«ç¢ºå®Ÿæ€§ã¯å°‘ãªã„ã€‚

èµ·ãã«ãã„å ´åˆã¯å„ç’°å¢ƒã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®è©¦ã¿ã‚’å¢—ã‚„ã™ã¨å†ç¾ç‡ãŒé«˜ã¾ã‚‹ã€‚ãã‚Œã§ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒ¼ãƒã‚’å¤‰ãˆã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§å†ç¾ç‡ãŒé«˜ã¾ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
